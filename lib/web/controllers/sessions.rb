module Web
  module Controllers
    # Controller to handle all routes relating to module sessions.
    class Sessions < Base
      get '/' do
        json Web::Models::Session.all
      end

      get '/:session_id' do
        session = Web::Models::Session.find_by_id(params['session_id'])
        halt 404 unless session

        json(
          id: session.id,
          module_path: session.module_path,
          created_at: session.created_at,
          events: session.events
        )
      end

      get '/:session_id/events/:min_id' do
        session = Web::Models::Session.find_by_id(params['session_id'])
        halt 404 unless session
        json session.events.where('id > ?', params['min_id']).order(:id)
      end

      post '/:session_id/kill' do
        session = Sessions.active_sessions.find { |s| s[:id].to_s == params['session_id'] }
        halt 404 unless session

        Sessions.active_sessions.delete(session)
        session[:module].kill
      end

      def self.active_sessions
        @@active_sessions ||= []
      end
    end
  end
end
